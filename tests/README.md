# Reen Integration Tests

This directory contains end-to-end integration tests for the reen system.

## Test Structure

### Money Transfer Test

The `money transfer` directory contains a complete test case that demonstrates the full reen workflow:

```
tests/money transfer/
├── drafts/              # Input: Draft specifications
│   ├── account.md
│   └── money_transfer.md
├── contexts/            # Generated: Formal specifications
│   ├── account.md       (generated by reen)
│   └── money_transfer.md (generated by reen)
├── src/
│   ├── types/          # Pre-defined types (not generated)
│   │   └── mod.rs
│   ├── contexts/       # Generated: Implementation
│   │   └── (generated by reen)
│   └── lib.rs          # Library entry point
├── tests/              # Generated: Test files
│   └── (generated by reen)
└── Cargo.toml
```

## Running the Tests

### Option 1: Shell Script (Recommended for first run)

The shell script provides detailed output and step-by-step verification:

```bash
./tests/e2e_money_transfer_test.sh
```

This will:
1. Build reen
2. Create specifications from drafts
3. Create implementation from specifications
4. Create tests
5. Compile the generated code
6. Run a manual integration test that:
   - Creates two accounts (A with 1000, B with 500)
   - Transfers 100 from A to B
   - Verifies final balances (A: 900, B: 600)

### Option 2: Rust Integration Test

Run the Rust-based integration test (requires API keys):

```bash
# Run the full e2e test
cargo test e2e_money_transfer --test e2e_test -- --nocapture --ignored

# Run just the functionality test (after e2e has generated code)
cargo test test_money_transfer_functionality --test e2e_test -- --nocapture --ignored
```

Note: These tests are marked as `#[ignore]` because they:
- Require API keys to be set
- Take longer to run (LLM API calls)
- Modify files in the test directory

## Prerequisites

Before running the tests, ensure:

1. **API Keys are set**:
   ```bash
   export ANTHROPIC_API_KEY='your-key-here'
   # OR
   export OPENAI_API_KEY='your-key-here'
   ```

2. **Python dependencies installed**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Agent registry configured** at `agents/agent_model_registry.yml`:
   ```yaml
   create_specifications: gpt-4
   create_implementation: claude-3-opus-20240229
   create_test: gpt-4
   ```

## What Gets Tested

The e2e test verifies:

1. **Specification Generation**: Draft documents are transformed into formal specifications
2. **Implementation Generation**: Specifications are converted into working Rust code
3. **Test Generation**: Tests are created from specifications
4. **Compilation**: All generated code compiles without errors
5. **Functionality**: The money transfer logic works correctly:
   - Account balances are calculated correctly
   - Transfers update balances appropriately
   - Currency validation works
   - Monthly limits are enforced (if implemented)

## Expected Behavior

### Success Criteria

A successful test run should show:
- ✓ All specifications created
- ✓ Implementation files generated in `src/contexts/`
- ✓ Code compiles without errors
- ✓ Transfer test passes (100 transferred from A to B)

### Possible Issues

If tests fail, common causes include:

1. **API Rate Limits**: LLM APIs may have rate limits
2. **Model Availability**: Specified models must be available with your API key
3. **Generated Code Quality**: AI-generated code may occasionally need manual fixes
4. **Missing Dependencies**: Ensure `chrono` is in the test Cargo.toml

## Manual Testing

You can also run the workflow manually:

```bash
cd "tests/money transfer"

# Step 1: Create specifications
../../target/release/reen create specification

# Step 2: Create implementation
../../target/release/reen create implementation

# Step 3: Create tests
../../target/release/reen create tests

# Step 4: Build
cargo build

# Step 5: Run tests
cargo test

# Step 6: Check the generated code
ls -la src/contexts/
cat src/contexts/account.rs
cat src/contexts/money_transfer.rs
```

## Understanding the Test Case

### Domain: Money Transfer System

The test implements a simple ledger-based money transfer system:

- **Account**: Represents a financial account with:
  - Balance (calculated from ledger entries)
  - Currency
  - Monthly transfer limit (100,000 max)

- **MoneyTransfer**: Transfers money between accounts:
  - Validates currency matches
  - Checks monthly limits
  - Creates ledger entries
  - Ensures atomicity

### Key Concepts

- **Ledger**: Immutable append-only log of transactions
- **LedgerEntry**: Records source, sink, amount, currency, timestamp
- **AccountId**: Either `Unsettled` or `Settled(id)`
- **Role-based design**: Source and sink accounts play different roles

### Test Scenario

```
Initial State:
  Account A: 1000 USD
  Account B: 500 USD

Action:
  Transfer 100 USD from A to B

Expected Final State:
  Account A: 900 USD
  Account B: 600 USD
```

## Troubleshooting

### "Agent not found" error
Make sure you're running from the project root directory.

### "Python runner failed"
Check that:
- Python 3 is installed
- Dependencies are installed: `pip install -r requirements.txt`
- API keys are set correctly

### "Compilation failed"
The generated code may need manual adjustments. Check:
- `src/contexts/` for the generated implementation
- Compiler error messages for specific issues

### Tests timeout
LLM API calls can be slow. The test may take several minutes to complete.

## Next Steps

After a successful test run:

1. Examine the generated specifications in `contexts/`
2. Review the implementation in `src/contexts/`
3. Check the generated tests in `tests/`
4. Modify the drafts and re-run to see how reen handles changes

## Contributing

When adding new test cases:

1. Create a new directory under `tests/`
2. Add draft documents
3. Create appropriate types in `src/types/`
4. Add a test script similar to `e2e_money_transfer_test.sh`
5. Document expected behavior in a README
